# CadNav2 — file guide

This document is a map of what most files/folders do.

## Where to start

If you’re new to the codebase:
- `app/index.tsx` is the “real” app entry for the prototype UI shell (Map ⇄ Tools ⇄ Settings).
- `app/state/CadNavContext.tsx` is the central state manager (checkpoints + location + map controller).
- `components/MapCanvas.*.tsx` are the platform map implementations (web vs native).

## Top-level

- `.gitignore`
  - Git ignore rules for generated/dependency files.

- `README.md`
  - Project overview + how to run.

- `package-lock.json`
  - NPM dependency lockfile (generated by `npm install`).

- `package.json`

- `app.json`
  - Expo app configuration (name, slug, icons, etc).
  - **Currently empty**.

- `tsconfig.json`
  - TypeScript configuration.
  - Notably sets `compilerOptions.moduleSuffixes` so imports can resolve platform overrides in this order: `.web`, `.native`, then default.

## app/

Holds the Expo Router app plus the prototype UI shell.

- `app/_layout.tsx`
  - Expo Router root layout.
  - Wraps the app in a React Navigation theme provider and renders the current route via `<Slot />`.

- `app/index.tsx`
  - The prototype “app shell” for the workshop UI plan.
  - Wires providers (`CadNavProvider`, `PagerProvider`, safe-area), renders the `SwipePager`, and overlays the `BottomPageSelector`.
  - Defines the 3 pages: Map, Tools, Settings.

### app/screens/

- `app/screens/MapScreen.tsx`
  - Map page UI.
  - Renders `MapCanvas` and overlays (LOC button + `CompassOverlay`).
  - Handles location permission prompt and “Open Settings” fallback.
  - Implements “placing mode” banner (when dropping checkpoints).

- `app/screens/ToolsScreen.tsx`
  - Tools page UI.
  - Contains a collapsible “Checkpoints” section with the “subway/snake” visualization.
  - Implements “Place checkpoint” action (starts placing mode and jumps to the Map page).
  - Shows distances between checkpoints using `calculateDistanceMeters` + `formatDistance`.
  - Provides “quick jump” chips to scroll to Grid Tools / Placement / Share sections.

- `app/screens/SettingsScreen.tsx`
  - Settings page UI (placeholder cards for now).

### app/state/

- `app/state/CadNavContext.tsx`
  - Central app state and actions.
  - Owns:
    - Checkpoints list + selection
    - “placing checkpoint” mode
    - Current location + heading
    - The map controller ref (imperative `centerOn`/`getCenter` API)
  - Handles Expo Location permissions and subscriptions with extra defensive cleanup logic (especially for web runtimes).

- `app/state/PagerContext.tsx`
  - Small context that exposes `goToPage(index)`.
  - Lets screens (e.g. Tools) jump to the Map page without importing pager internals.

### app/components/

- `app/components/SwipePager.tsx`
  - Horizontal paging container built on `ScrollView`.
  - Supports two swipe modes:
    - `full`: normal paging swipe
    - `edge`: disables paging swipe and instead uses left/right edge responders (useful so the map can pan normally)
  - On web: adds left/right arrow key navigation.

- `app/components/BottomPageSelector.tsx`
  - Bottom pill-shaped tab bar overlay.
  - Controls active page index (Map / Tools / Settings).

- `app/components/CompassOverlay.tsx`
  - Small compass widget that can expand into a card.
  - When open, shows heading and a pointer toward the selected checkpoint bearing.

### app/utils/

- `app/utils/geo.ts`
  - Geographic math utilities:
    - `calculateBearingDegrees(from, to)`
    - `calculateDistanceMeters(from, to)` (haversine)
    - `formatDistance(meters)`

- `app/utils/platform.tsx`
  - Tiny platform helper for icons:
    - Uses SF Symbols via `expo-symbols` on iOS
    - Uses Material Icons everywhere else

## components/

Platform-specific map rendering implementations. There is an implicit `components/MapCanvas` import that resolves to the right file via TS/Metro platform suffixing.

- `components/MapCanvas.web.tsx`
  - Web map implementation using Leaflet via `react-leaflet`.
  - Dynamically injects Leaflet CSS into the document head.
  - Implements the shared `MapCanvasHandle` API (`centerOn`, `getCenter`).
  - Renders:
    - Checkpoint markers (grouped when multiple checkpoints share a coordinate)
    - A polyline connecting checkpoints
    - User location marker with optional heading “nose”
  - In “placing mode”, clicks on the map drop a checkpoint via `onPlaceCheckpointAt`.

- `components/MapCanvas.native.tsx`
  - Native map implementation using `react-native-maps`.
  - Implements the same `MapCanvasHandle` API (`centerOn`, `getCenter`).
  - Renders:
    - Checkpoint markers (grouped by coordinate)
    - A polyline connecting checkpoints
    - User location marker with optional heading indicator
  - In “placing mode”, taps on the map drop a checkpoint via `onPlaceCheckpointAt`.

## assets/

- `assets/icons/`
  - App icon assets (exact contents depend on your Expo config).

## docs/

- `docs/UI_PLAN.md`
  - Workshop draft notes for the intended UX (Map/Tools/Settings, swipe model, principles).
  - This file currently contains two similar plan drafts concatenated; treat it as scratchpad notes.

- `docs/FILE_GUIDE.md`
  - This file.
